# Directive: AI Review Policy

## Purpose

Define how AI-authored and high-risk code is marked, tracked, and reviewed so humans always know what needs extra scrutiny.

## Trigger

- [x] Manual (when writing, editing, or reviewing code)
- [x] On event (when the agent modifies a function tagged as high-risk)

## Inputs

| Name | Type | Required | Description |
|------|------|----------|-------------|
| File being modified | string | Yes | Path to the file the agent is writing or editing |

## Annotation Tags

Use these comment tags consistently across the codebase. Place them directly above the function or block they apply to.

### AI Authorship

Mark any function, component, or block **written entirely by the AI** (not just edited):

```typescript
// AI-AUTHORED
function calculateDiscount(price: number, tier: string): number {
  // ...
}
```

If a human later rewrites the function substantially, the tag can be removed. Minor human edits (renaming, formatting) do not remove the tag.

### High-Risk Tagging

Functions that touch **security, money, data deletion, auth, or external integrations** must be tagged with their review status:

```typescript
// HIGH-RISK-UNREVIEWED — handles payment processing
export async function chargeCustomer(customerId: string, amount: number) {
  // ...
}
```

After a human reviews and approves:

```typescript
// HIGH-RISK-REVIEWED by @username 2025-01-15 — handles payment processing
export async function chargeCustomer(customerId: string, amount: number) {
  // ...
}
```

### What Counts as High-Risk

A function is high-risk if it does any of the following:

- Processes payments or financial transactions
- Deletes or mutates user data
- Handles authentication or authorization
- Sends emails, SMS, or notifications to users
- Calls external APIs that cost money or have side effects
- Modifies permissions or access controls
- Runs database migrations or schema changes

When in doubt, tag it. It's cheaper to review something safe than to miss something dangerous.

## Steps

### When the agent writes new code

1. If the function was generated by the AI, add `// AI-AUTHORED` above it
2. If the function meets any high-risk criteria, add `// HIGH-RISK-UNREVIEWED — [reason]`
3. A function can have both tags

### When the agent edits an existing function

1. If the function has `// HIGH-RISK-REVIEWED`, reset it to `// HIGH-RISK-UNREVIEWED` and note the change
2. Inform the user: "I've modified a reviewed high-risk function. It now needs re-review."
3. Do **not** remove `// AI-AUTHORED` tags from functions you're editing — they stay

### When reviewing code

1. Look for `// HIGH-RISK-UNREVIEWED` tags — these are the priority
2. Look for `// AI-AUTHORED` tags — these need more careful review than human-written code
3. After reviewing a high-risk function, update the tag to `// HIGH-RISK-REVIEWED by @username YYYY-MM-DD`

## Outputs

- Annotated source code with consistent review markers
- Clear audit trail of what the AI wrote and what humans have verified

## Tracking High-Risk Functions

Maintain a summary in `PLANNING.md` under a `## High-Risk Functions` section:

```markdown
## High-Risk Functions

| Function | File | Status | Last Reviewed |
|----------|------|--------|---------------|
| chargeCustomer | lib/api/billing.ts | REVIEWED | 2025-01-15 |
| deleteUserAccount | lib/api/users.ts | UNREVIEWED | — |
```

Update this table when:
- A new high-risk function is created
- A reviewed function is modified (status resets to UNREVIEWED)
- A human completes a review

## Tools Used

None — this is a process directive, not a code execution directive.

## Error Handling

| Error | Recovery |
|-------|----------|
| Agent forgets to tag a high-risk function | During any code review, scan for untagged functions matching the high-risk criteria and add tags |
| Agent modifies a reviewed function without resetting the tag | Self-anneal: fix the tag, notify the user, log the error |
| Tags get removed during a refactor | Re-scan affected files and restore tags based on the high-risk criteria |

## Learned Constraints

<!--
  Updated by the agent during self-annealing.
  Each entry must include a date and be appended, never overwritten.
  Format: - YYYY-MM-DD: What was learned
-->
